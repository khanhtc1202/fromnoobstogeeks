<!DOCTYPE html><html lang="en_US"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> A Sample App for Flux Architecture · From Noobs To Geeks</title><meta name="description" content="A Sample App for Flux Architecture - khanhtc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/larry-hi.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fromnoobstogeeks.com/atom.xml" title="From Noobs To Geeks"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/larry-hi.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/projects/" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="https://github.com/khanhtc1202" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">A Sample App for Flux Architecture</h1><div class="post-info">Apr 15, 2018</div><div class="post-content"><p>Mình được tuyển về làm java dev nhưng do số nhọ, từ khi đi làm đến giờ số ngày dev java của mình chắc ít hơn đầu ngón tay. Bị quăng qua lại làm từ python, ruby, clojure, golang,...đến giờ thì cái gì đến cũng phải đến, mình bị dí sang làm react trong một dự án mới. Mình vốn cực kì noob frontend app, nên khi nhận được cụm <code>flux architecture</code> trong một buổi họp nọ, mình nhận ra ngay đấy là cứu cánh duy nhất của mình ( ngoài architecture ra thì mình không đặc biệt quan tâm cái gì lắm :)) ). Sau vài giờ google thì dù tìm lòi mắt mình cũng <code>không thấy cái sample nào tử tế hoặc đủ để noobs như mình hiểu</code> nên quyết định tự làm 1 cái, dù sao thì từ hướng architecture, flux cũng khá là thú vị.</p>
<a id="more"></a>
<p>Như tiêu đề, bài viết không có mục đích viết lại flux là gì, chỉ đơn giản là cung cấp source code một sample app thiết kế theo flux ( sử dụng react-redux ) cùng với một số note cá nhân rút ra được. Nếu không có đủ thời gian để tiêu phí, source code được public tại <a href="https://github.com/khanhtc1202/flux-arch-sample" target="_blank" rel="noopener">đây</a>.</p>
<h2 id="khái-quát-về-flux">Khái quát về flux</h2>
<p>Cái này thì mình thấy trên mạng sau vài phút googling thì có rất nhiều rồi, ví dụ như ở <a href="https://scotch.io/tutorials/creating-a-simple-shopping-cart-with-react-js-and-flux" target="_blank" rel="noopener">đây</a>, <a href="https://viblo.asia/p/flux-under-the-hood-NznmMd34Rr69" target="_blank" rel="noopener">đây</a> và cả ở <a href="https://blog.mimacom.com/introduction-to-react-and-flux/" target="_blank" rel="noopener">đây</a> nữa. Phần này khá nhiều bài và đầy đủ rồi, mình xin phép tập trung vào implement và lưu note :))</p>
<p>Ngoài những bài bên trên ra mình thấy có 1 bài dịch trên kipalog khá hay về flux, có thể tìm thấy tại <a href="https://kipalog.com/posts/Huong-dan-va-giai-thich-Flux-bang-hinh-ve" target="_blank" rel="noopener">đây</a>.</p>
<p>Cập nhật thêm một bài so sánh về flux architecture vs mvc architecture mình cảm thấy rất hữu ích tại <a href="http://jonnyreeves.co.uk/2016/redux-middleware/" target="_blank" rel="noopener">đây</a>.</p>
<p><img src="https://media.giphy.com/media/yvAqpqJoPRvYMOVz5l/giphy.gif"></p>
<h2 id="implement-flux">Implement Flux</h2>
<p>Chúng ta đi implement một sample app bao gồm 1 search box nhập từ khoá, kết quả tìm được in lên trang như sau. ( mình noob application nên nó chỉ <code>đẹp</code> được đến vậy là hết sức rồi :)) )</p>
<p><img src="https://media.giphy.com/media/RkN5nA5O00StGGwXVQ/giphy.gif"></p>
<p>Một vài điểm chú ý mình muốn nhắc lại trước khi bắt tay vào design</p>
<ol type="1">
<li>View là tập hợp của các components!!! Component nên tập trung vào chức năng, không nên tập trung vào giao diện.</li>
<li>Các component được define tuỳ ý bạn, tuy nhiên tuyệt đối không nên define 1 component lớn nhiều logic ( nếu lo lắng về việc view bị vụn nhiều component thì đọc 3. )</li>
<li>Dữ liệu của cả trang define thông qua State của trang đó. Sau mỗi action, State của trang được cập nhật đến trạng thái mới ( điều này đảm bảo view đồng nhất tránh bị thay đổi do trigger ở nhiều model khác nhau | lưu ý tránh nhầm lẫn với State của component )</li>
<li>Chỉ có các Action nắm biết cách thay đổi dữ liệu trên view, không được thay đổi bằng bất cứ phương pháp nào khác, kết quả sau mỗi action đều là State mới của trang ( điều này bổ sung cho 3. )</li>
</ol>
<p>Xem hình dưới để có hình dung tổng quát của cấu trúc khi đảm bảo những chú ý trên:</p>
<p><img src="https://i.imgur.com/om44nEa.png"></p>
<p>Dựa theo tư tưởng bên trên, ta thiết kế một project structure như sau:</p>
<ul>
<li><p>Các <code>Component</code> phát sinh event, được xử lý bằng các method ( đã được khai báo như là props (properties) của component ).</p></li>
<li><p>Các <code>Action</code> ( có vai trò như các callback ) định nghĩa phương thức thay đổi dữ liệu trên trang, kết quả trả về là state mới.</p></li>
<li><p>Các <code>Container</code> có 2 nhiện vụ chính là: <code>Bind data từ State của trang sang props của Component</code> và <code>Tuỳ theo method đã declare trong props của Component, ném (dispatch) các Action thích hợp</code>. Nhiệm vụ này thực hiện thông qua 2 method chính là <code>mapStateToProps</code> và <code>mapDispatchToProps</code>.</p></li>
<li><p>Các <code>Reducer</code> là nơi kiểm soát giá trị <code>input cho State mới</code>. Method <code>combineReducers</code> merge output của các reducer gán làm giá trị mới cho State.</p></li>
<li><p><code>state.js</code> define State struct của page app &amp; <code>store.js</code> là nơi gom đống reducers bên trên lại, quản lý State của toàn bộ page đó.</p></li>
</ul>
<blockquote>
<p>Những điều trên được đảm bảo bởi <code>redux</code> và các method của libs này. Trong ví dụ minh hoạ mình dùng libs <code>react-redux</code> để implement.</p>
</blockquote>
<p>Project's struct</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.src</span><br><span class="line">├── actions/</span><br><span class="line">├── components/</span><br><span class="line">├── containers/</span><br><span class="line">├── reducers/</span><br><span class="line">├── index.tsx</span><br><span class="line">├── state.ts</span><br><span class="line">└── store.ts</span><br></pre></td></tr></table></figure>
<p>Ngoài ra thì có thể chia thêm <code>types/</code> để define types hoặc action sử dụng.</p>
<p>OK bắt tay vào viết chắc nhanh ngấm hơn :))</p>
<p>Để implement sample app này mình chia nó ra thành 2 components là: <code>SearchBox</code> và <code>SearchResults</code> tương ứng như sau:</p>
<ol type="1">
<li>Component: SearchBox | Action: Type, Search | StoreToState: queryString, queryResults</li>
<li>Component: SearchResults | Action: non ! StoreToState: non :))) ( thằng ku này chỉ bind data từ state và show ra thôi :)) )</li>
</ol>
<p>Lý do mình chia ra như bên trên thành 2 component đơn giản chỉ là mình <code>thích</code> như vậy :)) hơn nữa, do kiến trúc đã flex nên việc define thêm bớt các component rất dễ dàng, miễn là đảm bảo đúng các chú ý đã nêu bên trên :)))</p>
<p>Ta có trình tự implement.</p>
<p><img src="https://i.imgur.com/Hw7PGiw.jpg?1"></p>
<h3 id="define-state">Define state</h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> State = &#123;</span><br><span class="line">  queryString: <span class="built_in">string</span>;</span><br><span class="line">  results: <span class="built_in">Array</span>&lt;Result&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="implement-component">Implement component</h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Props = &#123;</span><br><span class="line">    queryString: <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">type</span>: <span class="function">(<span class="params">text: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    search: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> SearchBox <span class="keyword">extends</span> React.Component&lt;Props, <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params">props: Props</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    render() &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="implement-action">Implement action</h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> SearchAction = &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">"SEARCH"</span>;</span><br><span class="line">    results: <span class="built_in">Array</span>&lt;Result&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> search = (): <span class="function"><span class="params">SearchAction</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// TODO do http request for query results from api here</span></span><br><span class="line">    <span class="keyword">const</span> results: <span class="built_in">Array</span>&lt;Result&gt; = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">"SEARCH"</span>,</span><br><span class="line">        results: results</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Chú ý 1 Action bắt buộc có trường type như sau ( lý do thì ở <a href="https://fromnoobstogeeks.com/2018/04/15/flux-arch/#Implement-reducer">đây</a> ) <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SearchAction = &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">"SEARCH"</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="implement-container">Implement container</h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DispatchProps = &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="function">(<span class="params">text: <span class="built_in">string</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    search: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapStateToProps: MapStateToProps&lt;<span class="built_in">any</span>, <span class="built_in">any</span>, State&gt; = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> queryString = state.queryString;</span><br><span class="line">    <span class="keyword">return</span> &#123; queryString &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps: MapDispatchToProps&lt;DispatchProps, <span class="built_in">any</span>&gt; = (</span><br><span class="line">    dispatch: Dispatch&lt;<span class="built_in">any</span>&gt;</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="function">(<span class="params">text: <span class="built_in">string</span></span>) =&gt;</span> &#123; dispatch(<span class="keyword">type</span>(text)); &#125;,</span><br><span class="line">        search: <span class="function"><span class="params">()</span> =&gt;</span> &#123; dispatch(search()); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(SearchBox);</span><br></pre></td></tr></table></figure>
<p><code>State</code> bên trên là state của page app.</p>
<p><code>queryString</code> props của <code>component SearchBox</code> được map với <code>queryString</code> strong <code>State</code>.</p>
<p><code>type</code> và <code>search</code> props của <code>component SearchBox</code> được <code>trigger để dispatch action</code> phù hợp.</p>
<h3 id="implement-reducer">Implement reducer</h3>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState: <span class="built_in">Array</span>&lt;Result&gt; = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (state: <span class="built_in">Array</span>&lt;Result&gt; = initialState, action: SearchAction): <span class="built_in">Array</span>&lt;Result&gt; =&gt; &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"SEARCH"</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> action.results</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Chú ý <code>action.type</code> đã define bên trên được dùng ở đây.</p>
<p>Giá trị trả về của các reducer được merge lại tại <code>reducer/index.js</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> combineReducers(&#123;</span><br><span class="line">    queryString: Type,</span><br><span class="line">    results: Search,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Chú ý State struct được map với kết quả trả về của <code>combieReducers</code>.</p>
<h3 id="store-và-index.tsx">Store và Index.tsx</h3>
<p>./store.ts <figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; applyMiddleware, createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createLogger &#125; <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> reducers <span class="keyword">from</span> <span class="string">"./reducers"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  reducers,</span><br><span class="line">  applyMiddleware(createLogger())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure></p>
<p>./index.tsx <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">"./store"</span>;</span><br><span class="line"><span class="keyword">import</span> SearchBox <span class="keyword">from</span> <span class="string">"./containers/SearchBox"</span>;</span><br><span class="line"><span class="keyword">import</span> SearchResults <span class="keyword">from</span> <span class="string">"./containers/SearchResults"</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;SearchBox/&gt;</span><br><span class="line">        &lt;SearchResults/&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>Chú ý module được import vào tại đây là <code>containers</code> và <code>store</code>.</p>
<p>Về <code>Provider</code> có thể tìm thấy giải thích chi tiết tại <a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#provider-store" target="_blank" rel="noopener">đây</a> hoặc một câu hỏi khá hay để hiểu thêm về provider có thể tìm thấy tại <a href="https://github.com/reactjs/react-redux/issues/719" target="_blank" rel="noopener">đây</a>.</p>
<p>Ok DONE! Mục tiêu lúc đầu do cay cú vì không tìm được cái sample nào chi tiết cho flux nên mình viết bài này với mode noobs như mình đọc xong cũng làm được :)). Nhưng nghĩ lại thì tut với sample thì vẫn chỉ là sample thôi, muốn hiểu thì cứ clone về nghịch là nhanh nhất :))</p>
<p>P/s: - Project struct trên là thành quả 2 ngày cãi nhau với thanh niên ngồi cạnh mình ở công ty, thanks to him :)) - Sếp :v anh có vô tình đọc được cái đống này thì xin tha cho em, chỉ làm frontend app nốt tháng này không em xin quit sớm :'( .</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/05/21/dependency-injection/" class="prev">PREV</a><a href="/2018/03/30/view-log/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fromnoobstogeeks';
var disqus_identifier = '2018/04/15/flux-arch/';
var disqus_title = 'A Sample App for Flux Architecture';
var disqus_url = 'https://fromnoobstogeeks.com/2018/04/15/flux-arch/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//fromnoobstogeeks.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2019 <a href="https://fromnoobstogeeks.com">khanhtc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>