<!DOCTYPE html><html lang="en_US"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Play around with goroutine · From Noobs To Geeks</title><meta name="description" content="Play around with goroutine - khanhtc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/larry-hi.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fromnoobstogeeks.com/atom.xml" title="From Noobs To Geeks"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/larry-hi.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/projects/" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="https://github.com/khanhtc1202" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Play around with goroutine</h1><div class="post-info">Jul 21, 2018</div><div class="post-content"><p>Hôm nay trong lúc lượn lờ <a href="https://tour.golang.org/list" target="_blank" rel="noopener">go tour</a> - một guide khá đầy đủ và thú vị giới thiệu về golang, mình bắt gặp một đoạn khá thú vị :)) <a id="more"></a></p>
<p>Trong mục concurrency in golang, giới thiệu về goroutine - một điểm rất mạnh của golang dùng thay thế cho thread trong các ngôn ngữ lập trình khác - item 7 có nhắc lại kiến thức về tree. Trong đó có đưa ra 1 quiz nhỏ như sau:</p>
<blockquote>
<p>There can be many different binary trees with the same sequence of values stored at the leaves. For example, here are two binary trees storing the sequence 1, 1, 2, 3, 5, 8, 13.</p>
</blockquote>
<p><img src="https://tour.golang.org/content/img/tree.png"></p>
<blockquote>
<p>A function to check whether two binary trees store the same sequence is quite complex in most languages. We'll use Go's concurrency and channels to write a simple solution.</p>
</blockquote>
<p>Một quiz nghe có vẻ đơn giản nhưng khi implement bằng một ngôn ngữ mới với công cụ mới nó cũng đem đến nhiều góc nhìn khá thú vị :))</p>
<p>Để giải quiz này, công cụ chúng ta cần là một phép duyệt tree, rất tự nhiên, phép duyệt được chọn để dùng trong trường hợp này là <strong>duyệt thứ tự trước</strong> hay <code>LNR</code> (một lý do khác để chọn phép duyệt này là hint của quiz cũng gợi ý dùng phép này :)) )</p>
<p>Theo suy nghĩ thông thường, ta có implement của phép duyệt LNR đơn giản như sau</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LNR</span><span class="params">(Tree T)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (T!=<span class="literal">NULL</span>) &#123;</span><br><span class="line">		LNR(T-&gt;Left);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%d "</span>, T-&gt;value);</span><br><span class="line">		LNR(T-&gt;Right);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Do quiz yêu cầu sử dụng <code>goroutine</code> - kết quả trả về từ goroutine cho main (có thể coi cũng là 1 goroutine khác) thông qua <code>channel</code> (các khái niệm đã nhắc đến trên đều được giải thích rất chi tiết trong <a href="https://tour.golang.org/list" target="_blank" rel="noopener">go tour</a> do đó không được nhắc lại trong bài viết nữa). Từ đó ta có implement đơn giản như sau:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WalkRecursion</span><span class="params">(t *tree.Tree, ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> t != <span class="literal">nil</span> &#123;</span><br><span class="line">		WalkRecursion(t.Left, ch)</span><br><span class="line">		ch &lt;- t.Value</span><br><span class="line">		WalkRecursion(t.Right, ch)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	<span class="keyword">go</span> WalkRecursion(tree.New(<span class="number">1</span>), ch)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> ch &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%d, "</span>,i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Compile và chạy đoạn trên ta dính lỗi sau:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br></pre></td></tr></table></figure>
<p>Sở dĩ có lỗi trên là do vòng <code>for</code> đoạn in kết quả trong hàm main là infinite loop, nguyên nhân do <code>for i := range ch</code> chỉ dừng khi channel <code>ch</code> được đóng - trong khi trong đoạn implement trên mình chưa thực hiện <code>close(ch)</code> :v</p>
<p>Sử dụng <code>defer</code> để close là không hiệu quả, lý do chính vì defer trong scope của main sẽ đợi for loop kết thúc :)) (một trick khác cũng liên quan chút ít đến vấn đề này có thể tìm thấy trong post <a href="https://kipalog.com/posts/2-cach-de-lam-memory-leak-trong-golang" target="_blank" rel="noopener">này</a> )</p>
<p>Nghĩ một cách đơn giản hơn, ta chỉ cần close channel tại thời điểm <code>WalkRecursion</code> đã chạy xong là được! Hay nói cách khác - đóng channel trả về dữ liệu tại thời điểm hàm push dữ liệu (supplier) đã chạy xong. Và để làm được điều đó, tất nhiên ta sẽ làm ở goroutine có supplier đang chạy :D</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		WalkRecursion(tree.New(<span class="number">1</span>), ch)</span><br><span class="line">		<span class="built_in">close</span>(ch)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> ch &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%d, "</span>,i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Đoạn code trên đã chạy ngon :)) tuy nhiên nhìn hơi...nặng nề, có lẽ do trong hint của quiz cũng chỉ ghi dùng <code>go Walk(tree.New(1), ch)</code> để <code>kick off</code> hàm duyệt cây. Để đạt được yêu cầu đó, ta sẽ đi giấu phần close channel vào trong hàm duyệt! Ta có thể viết lại hàm duyệt tree như sau:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WalkEmbedded</span><span class="params">(t *tree.Tree, ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(ch)</span><br><span class="line">	<span class="keyword">var</span> walk <span class="function"><span class="keyword">func</span><span class="params">(t *tree.Tree)</span></span></span><br><span class="line"><span class="function">	<span class="title">walk</span> = <span class="title">func</span><span class="params">(t *tree.Tree)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> t == <span class="literal">nil</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">		walk(t.Left)</span><br><span class="line">		ch &lt;- t.Value</span><br><span class="line">		walk(t.Right)</span><br><span class="line">	&#125;</span><br><span class="line">	walk(t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	<span class="keyword">go</span> WalkEmbedded(tree.New(<span class="number">1</span>), ch)</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>P/S: Sau khi ngó nghía chán đống quiz rồi mình mới phát hiện ra có public solutions của golang team trên github :'( . Tham khảo thêm solutions của golang team tại <a href="https://github.com/golang/tour/tree/master/solutions" target="_blank" rel="noopener">đây</a>.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/31/content-trick/" class="prev">PREV</a><a href="/2018/06/19/install-nodejs/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fromnoobstogeeks';
var disqus_identifier = '2018/07/21/play-around-with-gorountine/';
var disqus_title = 'Play around with goroutine';
var disqus_url = 'https://fromnoobstogeeks.com/2018/07/21/play-around-with-gorountine/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//fromnoobstogeeks.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2019 <a href="https://fromnoobstogeeks.com">khanhtc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>