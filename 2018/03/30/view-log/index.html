<!DOCTYPE html><html lang="en_US"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Log Viewer via HTTP · From Noobs To Geeks</title><meta name="description" content="Log Viewer via HTTP - khanhtc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/images/larry-hi.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fromnoobstogeeks.com/atom.xml" title="From Noobs To Geeks"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/larry-hi.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/projects/" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="https://github.com/khanhtc1202" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Log Viewer via HTTP</h1><div class="post-info">Mar 30, 2018</div><div class="post-content"><p>Nhân một cuối tuần rảnh rỗi cao hứng nào đấy, mình đã build một hệ thống nhỏ - mục đích chính để nó giúp mình <code>clone tự động anime mới</code> từ các trang mình đã thu thập rss (phần vì mình lười down từng tập, phần do đợt này mình hay quên nên @@).</p>
<p>Do là cái hệ thống viết chơi bời trong 2 ngày nghỉ nên nó thiếu đủ thứ m(- -)m... Lúc đầu, mình chỉ tập trung vào viết cho nó chạy, nhưng thời gian đầu - do một số lý do khó nói - mà nó chết sập liên tục @@ mình bắt đầu nghĩ đến logging, tất nhiên là log ra file thôi...Sau đấy một thời gian khi đã chạy khá ổn định, dần dần bản thân việc <code>mò vào server để mở file log ra đọc</code> mình cũng lười nốt m(- -)m nên bắt đầu nghĩ xem có cách nào đơn giản (không phải cài hay dùng thêm dịch vụ ngoài nào) mà có thể giúp xem luôn log file ở server từ trình duyệt không :))</p>
<a id="more"></a>
<p>Ý tưởng giải quyết vấn đề của mình như sau: Nếu có thể serve text data trong log file như data thông thường và gửi chúng trong response trả về thì vấn đề cần giải quyết chỉ là <code>làm cách nào để lấy được log data dưới dạng stream và dán nó lên stream data của response</code> - giải quyết được vấn đề này thì có thể đọc log qua http thông qua 1 request đơn giản lên server rồi. (Lý do phải đọc log data từ log file dưới dạng stream là do log file lớn đọc trong 1 lần thì tốn ram quá, nhất là với cái server dùng ké của mình @@)</p>
<p>Từ đó mình nghĩ các bước thực hiện như sau (do mình đã viết xong khung cho hệ thống từ trước nên bước viết endpoint mới là dễ dàng thực hiện và không được list ra ở đây): 1. Tìm cách đọc stream data từ log file (ở đây mình nghĩ ngay đến <code>tail</code> :)) ) 2. Tìm cách gọi được stream đó từ source code ( server của hệ thống mình viết bằng nodejs ) 3. Gắn stream data đọc được lên stream data của response trả về. 4. DONE!!!</p>
<p>Bắt tay vào làm nào :))</p>
<p>Trong nodejs, để sử dụng các linux command, cách đơn giản nhất là sử dụng thư viện <a href="https://nodejs.org/api/child_process.html" target="_blank" rel="noopener">child_process</a>, về cơ bản khi dùng method <code>spawn()</code> của thư viện này, 1 process mới được sinh ra và gán cho <code>&lt;ChildProcess&gt; object</code> thực hiện command và trả về kết quả bạn có thể gọi được thông qua property <code>.stdout</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">var</span> spawn = <span class="built_in">require</span>(<span class="string">'child_process'</span>).spawn;</span><br><span class="line">...</span><br><span class="line">obj.show = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.header(<span class="string">'Content-Type'</span>,<span class="string">'text/html;charset=utf-8'</span>);</span><br><span class="line">    <span class="keyword">var</span> tail = spawn(<span class="string">'tail'</span>, [<span class="string">'-f'</span>, config.app.logPath]);</span><br><span class="line">    <span class="built_in">console</span>.log(tail.stdout);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>kết quả thu được</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[nodemon] starting `node app.js`</span><br><span class="line">Loaded: <span class="built_in">log</span> controller.</span><br><span class="line">Loaded: monitor controller.</span><br><span class="line">Loaded: streamer controller.</span><br><span class="line">Loaded: videos controller.</span><br><span class="line">Server running on 127.0.0.1: 3000</span><br><span class="line">Loaded file [Fuyu] Citrus - 12 [720p].mkv ready to view!</span><br><span class="line">Loaded file [Fuyu] Hakumei to Mikochi - 11 [720p].mkv ready to view!</span><br><span class="line">Loaded file [Fuyu] Killing Bites - 11 [720p].mkv ready to view!</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Có vẻ đã get stream thành công :)) giờ gán nó cho data stream của response là xong :)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">var</span> spawn = <span class="built_in">require</span>(<span class="string">'child_process'</span>).spawn;</span><br><span class="line">...</span><br><span class="line">obj.show = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.header(<span class="string">'Content-Type'</span>,<span class="string">'text/html;charset=utf-8'</span>);</span><br><span class="line">    <span class="keyword">var</span> tail = spawn(<span class="string">'tail'</span>, [<span class="string">'-f'</span>, config.app.logPath]);</span><br><span class="line">    tail.stdout.pipe(res);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Ở đây mình dùng <code>pipe()</code> để stream đọc được đang ở <code>stdout</code> của process sinh ra bởi spawn() được viết thẳng sang cho res (socket) :)) chắc cũng không hẳn là socket nhưng theo ý hiểu ở đây có thể coi nó gần giống như vậy :D lý do vì</p>
<p><img src="https://i.imgur.com/LucItFe.png?1"></p>
<p>Như đã thấy trong hình trên, stream data của response chưa bắt được event end :)) lý do vì stdout của process đang chạy lệnh tail vẫn chưa hoàn thành (vì nó là tail mà :) ). Như vậy nếu bây giờ mình viết thêm gì đấy vào file log thì trên trình duyệt, nội dung của tab log mình đang xem cũng thay đổi luôn - quá tuyệt :)) thử nào...</p>
<p><a href="https://youtu.be/41XIFcZKfEU" target="_blank" rel="noopener"><img src="https://media.giphy.com/media/cm1SRZW8XOEGFZNy8V/giphy.gif"></a></p>
<p>Done!!! :)))) vậy là đã hoàn thành việc view log thông qua http, lại còn realtime nữa chứ :))))...</p>
<p>Nhưng có gì đấy không đúng ở đây @@ Nếu như mình ngắt kết nối đến server (tắt cái tab đang nhận log ở trình duyệt) thì sẽ thế nào với cái process get log stream :v Nghĩ thế nên mình lại vào server check lại và...</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ps aux | grep tail</span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root     12951  0.0  0.0   4408   248 pts/3    S+   07:55   0:00 tail -f logs/run.log</span><br><span class="line">root     12961  0.0  0.0   4408   248 pts/3    S+   07:59   0:00 tail -f logs/run.log</span><br><span class="line">root     12971  0.0  0.0   4408   248 pts/3    S+   08:05   0:00 tail -f logs/run.log</span><br></pre></td></tr></table></figure>
<p>Không ổn!!! Thế này đọc log 100 lần thì có cả trăm cái process chạy tail nó lưu lại ở server, nghĩ đến thôi đã thấy rùng mình @@.</p>
<p>Hiện trạng của cái log view như sau:</p>
<p><img src="https://i.imgur.com/vJbERcj.jpg"></p>
<p>Vấn đề hiện tại sẽ được giải quyết nếu bắt được trạng thái data stream của response bị terminated! Và rất may đây là nodejs :)) chẳng có gì ngoài event, do vậy vấn đề sẽ được giải quyết dễ dàng khi sửa đoạn code gán stream data như sau.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">var</span> spawn = <span class="built_in">require</span>(<span class="string">'child_process'</span>).spawn;</span><br><span class="line">...</span><br><span class="line">obj.show = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.header(<span class="string">'Content-Type'</span>,<span class="string">'text/html;charset=utf-8'</span>);</span><br><span class="line">    <span class="keyword">var</span> tail = spawn(<span class="string">'tail'</span>, [<span class="string">'-f'</span>, config.app.logPath]);</span><br><span class="line">    res.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Response ended"</span>);</span><br><span class="line">        tail.kill(<span class="string">"SIGINT"</span>);</span><br><span class="line">    &#125;).on(<span class="string">'finish'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Response finished successfully"</span>);</span><br><span class="line">        tail.kill(<span class="string">"SIGINT"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    tail.stdout.pipe(res);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Ở đây <code>'close'</code> là event sẽ được bắt khi response connection bị ngắt đột ngột và <code>'finish'</code> là event hit khi response connection bị đóng vì lý do tự nhiên (timeout của trình duyệt chẳng hạn). Khi bắt được event này, chỉ cần <code>kill</code> process đang chạy lệnh tail là xong (giống như lệnh kill trong linux thông thường).</p>
<p>Ok giờ thử lại nào! Đây là trạng thái của server khi có request đọc log đến.</p>
<p><img src="https://i.imgur.com/oxoyhf4.png"></p>
<p>Và giờ thì thử ngắt nó đi :))))</p>
<p><img src="https://i.imgur.com/pkxmpfI.png"></p>
<p>DONE!!!! Lần này thì có vẻ không còn vấn đề nào nữa :))) Định lười nhưng cuối cùng thành ra khá lòng vòng mới có thể giải quyết hết vấn đề @@ Nên nếu có cần đưa ra kết luận gì đó thì sẽ là đừng lười như mình, kết quả không tốt đẹp gì đâu :)))</p>
<p>P/S:</p>
<p>Repo source code của hệ thống clone anime cho bạn nào quan tâm:</p>
<p>https://github.com/khanhtc1202/animu-crawling-system</p>
<p>Bạn nào ngại cài lại thì down chung từ server của mình cũng được :)))</p>
<p>Nhân đây mình còn rất nhiều cuối tuần rảnh rỗi @@ còn hứng thì lúc nào cũng có :)) bạn nào có ý tưởng gì hay sẵn sàng chia sẻ thì mình xin một chân ngồi hóng nhé :))).</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/15/flux-arch/" class="prev">PREV</a><a href="/2018/03/26/compile-c-source/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'fromnoobstogeeks';
var disqus_identifier = '2018/03/30/view-log/';
var disqus_title = 'Log Viewer via HTTP';
var disqus_url = 'https://fromnoobstogeeks.com/2018/03/30/view-log/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//fromnoobstogeeks.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2019 <a href="https://fromnoobstogeeks.com">khanhtc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>